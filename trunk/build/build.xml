<?xml version="1.0" encoding="UTF-8"?>
<project name="XBlink" default="run" basedir="../">
	<description>
		说明:
			1. 用于构建正式版时,修改xblink.jar.pre
		
		本构建用来生成一个 zip 包，其中包括
			* API 文档
			* JDK1.6 版本 jar
			* JUnit 测试结果
		
		环境变量 ${DEPS} 声明了所有依赖 jar 的位置，它们应该包括：
			1. JUnit 4
		
		环境变量 ${OUTPUT} 声明了 zip 文件包的输出位置
		
		构建结束后，会删除所有临时文件
    </description>
	
	<property environment="env" />
	
	<property name="DEPS" value="${env.DEPS}" />
	<property name="OUTPUT" value="${env.OUTPUT}" />
	
	<property name="svn-version" value="r98"></property>
	<property name="xblink-version" value="0.7.0"></property>
	<tstamp>
		<format property="now-date" locale="zh" pattern="yyyyMMdd"/>
	</tstamp>
	<property name="tmp-dir" value="build/tmp"></property>
	<property name="pub-dir" value="build/pub"></property>
	<property name="classes-dir-jdk6" value="${tmp-dir}/jdk6"></property>
	<property name="classes-dir-test" value="${tmp-dir}/test"></property>
	<property name="javadoc-dir" value="${pub-dir}/api"></property>
	<property name="tmp-junitreport-dir" value="${tmp-dir}/junit-report"></property>
	<property name="pub-junitreport-dir" value="${pub-dir}/junit-report"></property>


	<!--  <property name="xblink.jar.pre" value="xblink-${xblink-version}-snapshot-${svn-version}-${now-date}"></property> -->
	<property name="xblink.jar.pre" value="xblink-${xblink-version}"></property>
	<!-- <property name="xblink.jar.pre" value="xblink-${xblink-version}"></property> --> <!-- 用于正式版 -->

	<property name="xblink.jar.source" value="${pub-dir}/${xblink.jar.pre}-source.jar"></property>
	<property name="xblink.jar.jdk6" value="${pub-dir}/${xblink.jar.pre}-jdk6.jar"></property>
	<property name="xblink.pub.zip" value="${OUTPUT}/${xblink.jar.pre}.zip"></property>
	

	
	<path id="xblink-classpath">
		<fileset dir="${DEPS}" includes="*.jar"></fileset>
		<pathelement location="build/deps" />
		<pathelement location="${JAVA_HOME}/jre/lib/rt.jar" />
		<pathelement location="${JAVA_HOME}/jre/javaws/javaws.jar" />
		<pathelement location="${JAVA_HOME}/jre/lib/charsets.jar" />
		<pathelement location="${JAVA_HOME}/lib/tools.jar" />
	</path>
	
	
	<target name="clean">
		<delete dir="${tmp-dir}"></delete>
		<delete dir="${pub-dir}"></delete>
	</target>
	
	<target name="init">
		<mkdir dir="${tmp-dir}"/>
		<mkdir dir="${classes-dir-jdk6}"/>
		<mkdir dir="${classes-dir-test}"/>
		<mkdir dir="${tmp-junitreport-dir}"/>
		<mkdir dir="${pub-dir}"/>
		<mkdir dir="${pub-junitreport-dir}"/>
		<mkdir dir="${javadoc-dir}"/>
	</target>
	
	<target name="create-jar">
		<jar destfile="${xblink.jar.source}" basedir="src" encoding="utf-8" ></jar>
		
		<javac destdir="${classes-dir-jdk6}" debuglevel="lines,vars,source" debug="true" srcdir="src" source="1.6" target="1.6" encoding="utf-8"
			classpathref="xblink-classpath" includeantruntime="false">
		</javac>
		<copy todir="${classes-dir-jdk6}">
			<fileset dir="src" excludes="**/*.java"></fileset>
		</copy>
		<jar destfile="${xblink.jar.jdk6}" basedir="${classes-dir-jdk6}"></jar>
	</target>
	
	<target name="test">
		<javac destdir="${classes-dir-test}" debuglevel="lines,vars,source" debug="true" srcdir="test" target="1.6" encoding="utf-8"
			includeantruntime="false">
			<classpath>
				<path refid="xblink-classpath"></path>
				<path path="${classes-dir-jdk6}"></path>
			</classpath>
		</javac>
		<copy todir="${classes-dir-test}">
			<fileset excludes="**/*.java" dir="test"></fileset>
		</copy>
		<junit fork="true" showoutput="false" printsummary="yes" filtertrace="true" maxmemory="256M" 
			haltonerror="true" haltonfailure="true">
			<classpath>
				<path path="${classes-dir-test}"></path>
				<path path="${classes-dir-jdk6}"></path>
				<path refid="xblink-classpath"/>
			</classpath>
			<batchtest todir="${tmp-junitreport-dir}">
				<fileset dir="test">
					<include name="org/xblink/TestAll.java"/>
				</fileset>
				<formatter type="xml"/>
			</batchtest>
		</junit>
		<junitreport todir="${pub-junitreport-dir}">
			<report format="frames" todir="${pub-junitreport-dir}"/>
			<fileset dir="${tmp-junitreport-dir}" includes="*.xml"></fileset>
		</junitreport>
	</target>
	
	<target name="jdoc">
		<javadoc sourcepath="src" classpathref="xblink-classpath" encoding="UTF-8" destdir="${javadoc-dir}" charset="utf-8" docencoding="utf-8"/>
	</target>
	
	<target name="create-zip">
		<zip destfile="${xblink.pub.zip}">
			<fileset dir="${pub-dir}"></fileset>
		</zip>
	</target>
	
	<target name="run">
		<antcall target="clean"></antcall>
		<antcall target="init"></antcall>
		<antcall target="create-jar"></antcall>
		<antcall target="test"></antcall>
		<antcall target="jdoc"></antcall>
		<antcall target="create-zip"></antcall>
		<antcall target="clean"></antcall>
	</target>
</project>
